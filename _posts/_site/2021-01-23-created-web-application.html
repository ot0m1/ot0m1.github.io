<p><a href="https://akkkky.hatenablog.jp/entry/2021/01/16/234329">Sinatra で Webアプリケーションを作った - tmp/log</a> の続き。 レビューいただいた点を修正しての気付きなど。</p>

<!-- more -->

<p>レビューいただいた点について修正にあたって以下の学びがあった。</p>

<h2 id="html-エスケープしたときに表示が崩れる">HTML エスケープしたときに表示が崩れる</h2>

<p>これは当初エスケープに利用している <code class="language-plaintext highlighter-rouge">Rack::Utils.escape_html</code> 側の出力に原因があると考えていた。そこでどんな処理をしているのかソースを見に行ったら、シンプルに記号を置換しているものであった。</p>

<p><a href="https://github.com/rack/rack/blob/a05f8d56f9ac4da14dddb8f312a3b43644f73397/lib/rack/utils.rb#L158">https://github.com/rack/rack/blob/a05f8d56f9ac4da14dddb8f312a3b43644f73397/lib/rack/utils.rb#L158</a></p>

<p>実際のコード</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ESCAPE_HTML</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"&amp;"</span> <span class="o">=&gt;</span> <span class="s2">"&amp;amp;"</span><span class="p">,</span>
    <span class="s2">"&lt;"</span> <span class="o">=&gt;</span> <span class="s2">"&amp;lt;"</span><span class="p">,</span>
    <span class="s2">"&gt;"</span> <span class="o">=&gt;</span> <span class="s2">"&amp;gt;"</span><span class="p">,</span>
    <span class="s2">"'"</span> <span class="o">=&gt;</span> <span class="s2">"&amp;#x27;"</span><span class="p">,</span>
    <span class="s1">'"'</span> <span class="o">=&gt;</span> <span class="s2">"&amp;quot;"</span><span class="p">,</span>
    <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"&amp;#x2F;"</span>
<span class="p">}</span>

<span class="no">ESCAPE_HTML_PATTERN</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">union</span><span class="p">(</span><span class="o">*</span><span class="no">ESCAPE_HTML</span><span class="p">.</span><span class="nf">keys</span><span class="p">)</span>

<span class="c1"># Escape ampersands, brackets and quotes to their HTML/XML entities.</span>
<span class="k">def</span> <span class="nf">escape_html</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">string</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="no">ESCAPE_HTML_PATTERN</span><span class="p">){</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="no">ESCAPE_HTML</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>なので出力される文字列が原因ではないということでもうちょっと自分の実装を追っていたら、単に<a href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>ケープした場合に文字列が長くなりすぎ、HTML の要素からはみ出てしまっているだけだった…。</p>

<p>スタイルで <code class="language-plaintext highlighter-rouge">overflow</code> を適切に設定していなかったことが原因。幸い15分くらいで原因に思い当たったので良かった。原因が <a href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a> のコード側にあると思いこんでいたらドハマリするところだった…。</p>

<h2 id="表示に関するコードはコントローラーに該当するファイルに書かない">表示に関するコードはコントローラーに該当するファイルに書かない</h2>

<p>コントローラーに該当する処理を書いていたファイル内で、一緒に HTML タグを操作していた。 View と Model で担当を分担するため書く場所は分けた方が良い。<a href="http://d.hatena.ne.jp/keyword/MVC">MVC</a> モデルを意識した実装をする。</p>

<h2 id="readme-に-ruby-の推奨バージョンを自然言語で書いていた">README に <a href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a> の推奨バージョンを<a href="http://d.hatena.ne.jp/keyword/%BC%AB%C1%B3%B8%C0%B8%EC">自然言語</a>で書いていた</h2>

<p><code class="language-plaintext highlighter-rouge">.ruby-version</code> をコミットしておくとよい。 確かに推奨バージョンを書いて利用者に人力でバージョン指定してもらうより rbenv にやってもらった方が全然いい…！</p>

