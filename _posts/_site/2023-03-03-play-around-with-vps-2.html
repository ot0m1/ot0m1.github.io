<p><a href="https://blog.otomi.world/play-around-with-vps-1/">前回</a>の続き。</p>

<!-- more -->

<h1 id="ファイアウォールの設定を変更する">ファイアウォールの設定を変更する</h1>

<p>現在さくらVPSのパケットフィルターという機能でファイアウォールを実現しているので、利用している VPS などに依存しないようにするべく、CentOS 7 が提供しているファイアウォールを利用するようにする。</p>

<p>CentOS 7 ではファイアウォールに Firewalld というソフトウェアが使われている。<br />ファイアウォールの設定集ゾーンには public home work などがある。ゾーンは自分で独自に作ったり、既存のものの設定を変更したりできる。<br />
デフォルトの設定だと public が厳しめ、home が緩め。</p>

<p>まずは起動させる。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start firewalld
</code></pre></div></div>

<p>自動起動するように設定する。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>firewalld
</code></pre></div></div>

<h2 id="設定を変更する">設定を変更する</h2>

<p>実際にファイアウォールの設定を変更してみる。<br />
コマンドは <code class="language-plaintext highlighter-rouge">firawall-cmd</code> というものを使う。</p>

<h2 id="現在のファイアウォールの設定を確認する">現在のファイアウォールの設定を確認する</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd <span class="nt">--list-all</span>
</code></pre></div></div>

<p>以下のように表示される。<code class="language-plaintext highlighter-rouge">services</code> の欄が現在通信を許可しているプロトコル。<br />
デフォルトでは http と https の通信が許可されていないことがわかる。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources: 
  services: dhcpv6-client ssh
  ports: 
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 
</code></pre></div></div>

<h2 id="ゾーンの設定を変更して-http-と-https-を許可する">ゾーンの設定を変更して http と https を許可する</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--add-service</span><span class="o">={</span>http,https<span class="o">}</span> <span class="nt">--permanent</span>
</code></pre></div></div>

<p>複数の service を追加する場合は、{} で囲む。これは firewalld ではなく bash の brace 展開を利用している。
permanent オプションをつけてサーバーが再起動しても変更した設定が有効なままにする。
<code class="language-plaintext highlighter-rouge">success</code> と表示されたらよい。</p>

<p>このままでは設定が反映されないので、設定の再読み込みを行う。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd <span class="nt">--reload</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">success</code> と表示されたらよい。
再度設定を確認してみると、http と https が許可されていることがわかる。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>irewall-cmd <span class="nt">--list-all</span>
public <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources: 
  services: dhcpv6-client http https ssh
  ports: 
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 
</code></pre></div></div>

<p>ここまでできたらさくらVPSのパケットフィルターを無効にする。</p>

<p><img src="https://user-images.githubusercontent.com/6190966/222335409-4d304035-a3aa-4050-87e8-fb5bab5b12dd.png" /></p>
