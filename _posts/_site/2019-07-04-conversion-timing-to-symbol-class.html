<p><a href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>のハッシュのキーのSymbolクラスへの変換の挙動が面白かったので、備忘録として書く。</p>

<!-- more -->

<h2 id="前提">前提</h2>

<p><a href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>のハッシュのキーにはどんな種類のオブジェクトでも書くことができる。 また、ハッシュの書き方には<code class="language-plaintext highlighter-rouge">{key =&gt; value}</code>と書く場合と<code class="language-plaintext highlighter-rouge">{key: value}</code>の二種類がある。</p>

<p><code class="language-plaintext highlighter-rouge">{key =&gt; value}</code>と書くと、キーには入れたオブジェクトがそのまま設定される。<code class="language-plaintext highlighter-rouge">{key: value}</code>と書くと、キーはSymbolクラスに変換される。</p>

<p>Symbolクラスに変換されるのだが、クラスによってはto_symメソッドを持っていないので、ハッシュロケットでしか書けない場合がある。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># キーがシンボル以外の場合は =&gt;（ハッシュロケット） で書く必要がある</span>
<span class="c1"># キーがシンボルの場合は : で書く必要がある</span>
<span class="c1"># だが、Stringクラスはto_symメソッドがあるので、 : で書いても暗黙的にSymbolクラスのオブジェクトに変換してくれる</span>

<span class="n">hash1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"a"</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="n">hash1</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
  <span class="nb">p</span> <span class="s2">"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2"> のクラス=&gt; </span><span class="si">#{</span><span class="n">key</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="c1"># =&gt; "a のクラス=&gt; String"</span>
<span class="c1"># =&gt; "b のクラス=&gt; Symbol"</span>

<span class="c1"># Integerクラスはto_symメソッドがないので、この書き方はできない</span>
<span class="c1"># syntax error, unexpected ':', expecting =&gt; のエラーが発生する</span>
<span class="n">hash2</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="c1"># ハッシュロケットで書く必要がある</span>
<span class="n">hash3</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">}</span>
</code></pre></div></div>

<p>文字列aはStringクラスのままだが、文字列bはSymbolクラスのオブジェクトになっていることが分かる。</p>

<h2 id="シンボルを作成できる文字列">シンボルを作成できる文字列</h2>

<p>シンボルを作成するにはコロンに続けて変数名やクラス名、メソッド名の識別子として有効な文字列を書く。（要は数字で始まったりハイフンやスペースが含まれていない文字列）</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># OK</span>
<span class="ss">:This</span>
<span class="ss">:is</span>
<span class="ss">:_a</span>
<span class="ss">:pen_4</span>
<span class="p">:</span><span class="vg">$dollar_mark_is_ok</span>
<span class="ss">:@at_mark_is_ok</span>
<span class="ss">:"hoge"</span> <span class="c1"># さらには</span>
<span class="ss">:"fuga_piyo"</span> <span class="c1"># こんな風に文字列として</span>
<span class="ss">:"1234 5678"</span> <span class="c1"># シンボルを作成することも可能</span>

<span class="c1"># NG</span>
<span class="p">:</span><span class="mi">1</span> <span class="c1"># syntax error, unexpected tINTEGER, expecting tSTRING_CONTENT or tSTRING_DBEG or tSTRING_DVAR or tSTRING_END</span>
<span class="ss">:I</span> <span class="n">have</span> <span class="n">a</span> <span class="n">pen</span> <span class="c1"># syntax error, unexpected tIDENTIFIER, expecting end-of-input</span>
<span class="ss">:I</span><span class="o">-</span><span class="n">have</span><span class="o">-</span><span class="n">an</span><span class="o">-</span><span class="n">apple</span> <span class="c1"># `&lt;main&gt;': undefined local variable or method `have' for main:Object (NameError)</span>
</code></pre></div></div>

<h2 id="上記から推測されること">上記から推測されること</h2>

<p>ハッシュを作成するときに<code class="language-plaintext highlighter-rouge">{key: value}</code>と書く場合と、<code class="language-plaintext highlighter-rouge">:String</code>と書く場合とで同じことが行われている模様。</p>

<h2 id="本題">本題</h2>

<p>ここでやっと本題。ハッシュのキーにスペースが含まれている場合はどうなるか。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 変数名やクラス名、メソッド名の識別子として有効な文字列ではないのでエラーとなる</span>
<span class="n">hash4</span> <span class="o">=</span> <span class="p">{</span><span class="n">this</span> <span class="ss">is: </span><span class="s2">"a pen"</span><span class="p">}</span> <span class="c1"># =&gt; syntax error, unexpected tLABEL, expecting do or '{' or '('</span>

<span class="c1"># to_symメソッドがあるStringクラスのオブジェクトをキーにしているのでSymbolクラスのオブジェクトに変換してくれる</span>
<span class="n">hash5</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"this is a"</span><span class="p">:</span> <span class="s2">"pen"</span><span class="p">,</span> <span class="s2">"this is an"</span> <span class="o">=&gt;</span> <span class="s2">"apple"</span><span class="p">}</span>

<span class="c1"># "this is a"文字列はSymbolクラスのオブジェクトになっているのでStringクラスのオブジェクトでは値がとれない</span>
<span class="nb">p</span> <span class="n">hash5</span><span class="p">[</span><span class="s2">"this is a"</span><span class="p">]</span> <span class="c1"># =&gt; nil</span>

<span class="c1"># "this is an"小文字はStringクラスなので値がとれる</span>
<span class="nb">p</span> <span class="n">hash5</span><span class="p">[</span><span class="s2">"this is an"</span><span class="p">]</span> <span class="c1"># =&gt; "apple"</span>

<span class="c1"># Symbolクラスのオブジェクトに変換することで値がとれる</span>
<span class="nb">p</span> <span class="n">hash5</span><span class="p">[</span><span class="ss">:"this is a"</span><span class="p">]</span> <span class="c1"># =&gt; "pen"</span>

<span class="c1"># ここでも変数名やクラス名、メソッド名の識別子として有効な文字列ではないのでエラーとなる</span>
<span class="nb">p</span> <span class="n">hash5</span><span class="p">[</span><span class="ss">:this</span> <span class="n">is</span> <span class="n">a</span><span class="p">]</span> <span class="c1"># =&gt; syntax error, unexpected tIDENTIFIER, expecting ']'</span>
</code></pre></div></div>

<h2 id="調べた結論">調べた結論</h2>

<p><code class="language-plaintext highlighter-rouge">:String</code>と書いてシンボルを作成する場合や、ハッシュを作成するときに<code class="language-plaintext highlighter-rouge">{key : value}</code>と書く場合、<code class="language-plaintext highlighter-rouge">key.to_sym</code>メソッドが実行されている。</p>

<p>要はどうしても空白が含まれる文字列をSymbolオブジェクトとしてキーに設定したい場合、<code class="language-plaintext highlighter-rouge">{"String": value}</code>と書いてから変換してもらえばいいちゅうことです。</p>

