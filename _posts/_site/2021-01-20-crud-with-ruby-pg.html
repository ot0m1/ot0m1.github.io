<p><a href="http://localhost:4000/trying-to-touch-ruby-pg/">ruby-pg を触ってみる</a>の続き。</p>

<!-- more -->

<p><a href="http://localhost:4000/trying-to-touch-ruby-pg/">ruby-pg を触ってみる</a>の記事で以下のように書いていたが、これは今回のやりたいことのスコープから外れるのでやらない。 予め <code class="language-plaintext highlighter-rouge">sinatra_db</code> というデータベースが存在すること前提。</p>

<blockquote>
  <p>Tableできた。が、これってpostgresっていうデータベースが存在することが予め分かっているのでコネクションを張れているが、自作の<a href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>のWebアプリケーションをcloneしてもらって他の人のパソコン上で動かすときはデータベース名どうやって決めればいいのだろうか？</p>
</blockquote>

<p>とりあえず CRUD ができるかの最小限のコードを書いてみる。</p>

<p><strong>このコードは<a href="http://d.hatena.ne.jp/keyword/SQL%A5%A4%A5%F3%A5%B8%A5%A7%A5%AF%A5%B7%A5%E7%A5%F3">SQLインジェクション</a>が実行可能なので、必ず個人環境でテストするだけに留めてください。<br />
絶対に個人情報を扱っているような環境に実装するようなことはしないでください。</strong></p>

<p>以下の記事に<a href="http://d.hatena.ne.jp/keyword/SQL%A5%A4%A5%F3%A5%B8%A5%A7%A5%AF%A5%B7%A5%E7%A5%F3">SQLインジェクション</a>を回避できるコードを載せているのでこちらも参照ください。</p>

<p><a href="http://localhost:4000/avoiding-sql-Injection/">prepared statement を利用してSQLインジェクションを回避する</a></p>

<p>👇 CRUD ができるかの最小限のコード</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'pg'</span>

<span class="c1"># sinatra_db という DB は予め作成しておく</span>

<span class="no">DB_NAME</span> <span class="o">=</span> <span class="s1">'sinatra_db'</span>
<span class="no">TABLE_NAME</span> <span class="o">=</span> <span class="s1">'sinatra_table'</span>

<span class="c1"># コネクション作成 </span>
<span class="n">connection</span> <span class="o">=</span> <span class="no">PG</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">dbname: </span><span class="s2">"</span><span class="si">#{</span><span class="no">DB_NAME</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># table が存在するか確認</span>
<span class="k">def</span> <span class="nf">table_exist?</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">exist_table_query</span> <span class="o">=</span> <span class="s2">"SELECT table_name FROM information_schema.tables WHERE table_name = '</span><span class="si">#{</span><span class="no">TABLE_NAME</span><span class="si">}</span><span class="s2">'"</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="n">exist_table_query</span><span class="p">).</span><span class="nf">cmd_status</span> <span class="o">==</span> <span class="s1">'SELECT 1'</span> <span class="p">?</span> <span class="kp">true</span> <span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="c1"># table 作成</span>
<span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">create_table_query</span> <span class="o">=</span> <span class="s2">"CREATE TABLE </span><span class="si">#{</span><span class="no">TABLE_NAME</span><span class="si">}</span><span class="s2"> (id SERIAL, title TEXT NOT NULL, body TEXT)"</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="n">create_table_query</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># メモの新規作成 RETURNING id で追加した id を返す</span>
<span class="k">def</span> <span class="nf">create_note</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
  <span class="n">create_note_query</span> <span class="o">=</span> <span class="s2">"INSERT INTO </span><span class="si">#{</span><span class="no">TABLE_NAME</span><span class="si">}</span><span class="s2"> (title, body) VALUES ('</span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="s2">') RETURNING id"</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="n">create_note_query</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># メモの編集</span>
<span class="k">def</span> <span class="nf">update_note</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
  <span class="n">update_note_query</span> <span class="o">=</span> <span class="s2">"UPDATE </span><span class="si">#{</span><span class="no">TABLE_NAME</span><span class="si">}</span><span class="s2"> SET (title, body) = ('</span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="s2">') WHERE id = </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="n">update_note_query</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># メモの削除</span>
<span class="k">def</span> <span class="nf">delete_note</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="n">delete_note_query</span> <span class="o">=</span> <span class="s2">"DELETE FROM </span><span class="si">#{</span><span class="no">TABLE_NAME</span><span class="si">}</span><span class="s2"> WHERE id = </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="n">delete_note_query</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p><a href="http://d.hatena.ne.jp/keyword/CRUD">CRUD</a> の各メソッド自体はクエリをそのまま書くようなものだったので割とすぐ実装できたが、table が存在しない場合に追加するための存在確認メソッドを作成したが、table の存在確認をどのように実装するかに時間がかかった。</p>

<p><a href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> や <a href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>-pg には引数で table 名を受け取って boolean で存在有無を返すようなメソッドが無いっぽかったので <code class="language-plaintext highlighter-rouge">information_schema.tables</code> を使ったが、もっとスマートに書けるのかなー。 table の存在確認はググっても様々なやり方が出てくるし、色々な方法で確認できるのだろう。</p>

